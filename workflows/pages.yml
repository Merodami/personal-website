# .github/workflows/pages.yml
name: CI & Deploy to Cloudflare Pages

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Triggers
#   â€¢ Production deploys on pushes to main
#   â€¢ Preview environments on pullâ€‘requests to main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30 # failâ€‘fast safety

    # Abort superseded runs (e.g. forceâ€‘pushes)
    concurrency:
      group: pages-${{ github.head_ref || github.ref }}
      cancel-in-progress: true

    # Minimal permissions for secure deployments
    permissions:
      contents: read
      deployments: write

    steps:
      # â€”â€”â€” Check out repo â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4

      # â€”â€”â€” Toolchain setup â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ”§ Setup Node .js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # active LTS
          cache: npm # automatic npm cache

      # â€”â€”â€” Install, test, lint â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§¹ Lint
        run: npm run lint

      # If you have tests, uncomment the block below
      # - name: ğŸ§ª Test
      #   run: npm test --if-present

      # â€”â€”â€” Build Astro for Pages â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ—ï¸ Build site
        run: npm run build # runs `astro build` â†’ ./dist

      # â€”â€”â€” Install Wrangler globally first â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ§° Install Wrangler
        run: npm install -g wrangler@latest

      # â€”â€”â€” Deploy with Wrangler CLI directly â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸš€ Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NODE_VERSION: 20
        run: wrangler pages deploy dist --project-name=personal-website --branch=${{ github.ref_name }}
